window.TApi.tenant=(function(a){var c=a.tenant||{};var e;var b;function d(){var f=localStorage.getItem("userInfo");if(f){b=JSON.parse(f)}else{c.resetUserInfo()}}c.resetUserInfo=function(){b={localUser:"",userGroup:"",tenantCode:"",mallOrgId:"",orgId:"",orgCode:"",orgPrefix:"",accessId:"",localStoreList:[],tillMap:[],issueStore:""};localStorage.removeItem("userInfo")};c.getLocalUser=function(){return b.localUser};c.getUserGroup=function(){return b.userGroup};c.getTenantCode=function(){return b.tenantCode};c.getMallOrgId=function(){return b.mallOrgId};c.getOrgId=function(){return b.orgId};c.getOrgCode=function(){return b.orgCode};c.getOrgPrefix=function(){return b.orgPrefix};c.getAccessId=function(){return b.accessId};c.getLocalStores=function(){return b.localStoreList};c.getTillIds=function(h){for(var f=0,g=b.tillMap.length;f<g;++f){if(b.tillMap[f].storecode==h){return b.tillMap[f].tillIds}}return[]};c.getIssueStore=function(){return b.issueStore};c.retrieveContactId=function(f){TAjax.request({path:PosServicePath.MOBILETENANT_FN_GETCONTACTID,params:{plat:AppContext.getConfig("releaseType"),media:AppContext.getConfig("media"),code:f},success:function(g){var h=JSON.parse(g.responseText);e=h.contactId}})};c.wechatLogin=function(f){c.login(f,{callback:function(h,g){e=g.contactId;if(!h){AppContext.resetPageStack("#VLogin")}}})};c.login=function(f,g){var h={staff:f,media:AppContext.getConfig("media"),plat:AppContext.getConfig("releaseType")};if(g.pwd){h.pwd=g.pwd;h.contactId=e}TAjax.request({path:PosServicePath.MOBILETENANT_FN_LOGIN,params:h,success:function(i){var j=JSON.parse(i.responseText);if(j.errorCode!=0){c.resetUserInfo();if(g.callback){g.callback(false,j)}return}b={localUser:j.staffCode,userGroup:j.userGroup,tenantCode:j.tenantCode,mallOrgId:j.mallOrgId,orgId:j.orgId,orgCode:j.orgCode,orgPrefix:j.orgPrefix,accessId:j.accessId,localStoreList:j.storeList,tillMap:j.tillMap,issueStore:j.issueStore};localStorage.setItem("userInfo",JSON.stringify(b));localStorage.removeItem("logout");AppContext.resetPageStack("#VHome");if(g.callback){g.callback(true,j)}},fail:function(){c.resetUserInfo()}})};c.logout=function(){c.resetUserInfo();localStorage.setItem("logout",true);AppContext.resetPageStack("#VLogin")};c.checkLogin=function(){var f=a.tenant.getLocalUser();if(!f||!localStorage.getItem("userInfo")){function g(){var i="#VLogin";if(location.hash!=i){AppContext.resetPageStack(i)}else{AppContext.gotoView(i)}}if(a.Platform.isWechat()&&AppContext.getConfig("releaseType")=="wechat"){var h=a.wechat.getWechatCode();if(h){if(localStorage.getItem("logout")){a.tenant.retrieveContactId(h);g()}else{a.tenant.wechatLogin(h)}}}else{g()}return false}return true};c.modifyPwd=function(g,h,f){TAjax.request({path:PosServicePath.MOBILETENANT_FN_MODIFYPWD,params:{staffcode:c.getLocalUser(),oldPwd:g,newPwd:h},success:function(j){var i=JSON.parse(j.responseText);if(i.errorCode==0){TApi.Toast.show(Localize.getLangValue("ModifyPwdSuccess"));if(f){f()}}else{TApi.Toast.show(Localize.getLangValue("ModifyPwdFail"))}}})};d();return c})(window.TApi||{});window.TApi.theme=(function(a){var b=a.theme||{};function d(){b.changeTheme(b.getStyle())}function c(e){localStorage.setItem("_style",e)}b.getStyle=function(){return localStorage.getItem("_style")};b.changeTheme=function(f){var e=a.$id("cssStyle");if(!e){e=document.createElement("link");e.id="cssStyle";e.rel="stylesheet";document.head.appendChild(e)}if(!f){f="default"}c(f);e.href="resources/css/"+f+".css"};d();return b})(window.TApi||{});window.TApi.wechat=(function(b){var a=b.wechat||{};a.init=function(){var d=AppContext.getConfig("releaseType");if(d=="wechat"&&window.wx){var c=AppContext.getConfig("media");TAjax.request({path:"wechat61/getwechatjsconfig",jsonData:{wechatName:c},success:function(f){var e=Ext.decode(f.responseText);window.wx.config({debug:false,appId:e.appId,timestamp:e.timestamp,nonceStr:e.nonceStr,signature:e.signature,jsApiList:["showMenuItems","previewImage"]});window.wx.ready(function(){window.wx.showMenuItems({menuList:["menuItem:profile","menuItem:addContact"]})});window.wx.error(function(g){alert("wechat js sdk error: "+JSON.stringify(g))})}})}};a.getWechatCode=function(f){var c=b.getSearchParam("state"),e=b.getSearchParam("code"),g=sessionStorage.getItem("_code");sessionStorage.removeItem("_code");if(e&&c==g){return e}else{d()}function d(){function i(){function m(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return m()+m()+m()+m()+m()+m()+m()+m()}var l=i();var k=location.origin+location.pathname,h=AppContext.getConfig("serverUrl"),j=AppContext.getConfig("media");if(f){if(f.indexOf("#")!=0){k+="#"}k+=f}sessionStorage.setItem("_code",l);location.replace(h+PosServicePath.MOBILETENANT_AUTH+"?media="+j+"&redirect="+encodeURIComponent(k)+"&state="+l)}};return a})(window.TApi||{});
